<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerenciador de Macros com Firebase</title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
      color: #333;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    .macro-item {
      background: #e6fff2;
      border: 1px solid #b2dfdb;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      position: relative;
    }
    .macro-item strong {
      font-size: 16px;
      color: #004d40;
    }
    .macro-item pre {
      background: #ffffff;
      padding: 10px;
      border-radius: 6px;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-top: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #333;
    }
    .macro-buttons {
      margin-top: 10px;
    }
    .macro-buttons button {
      margin: 2px;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .favorite {
      color: gold;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Gerenciador de Macros</h1>

  <input type="text" id="busca" placeholder="Buscar macro" oninput="buscarMacros()" />

  <form id="formMacro">
    <input type="hidden" id="index_edicao" />
    <label>Nome da Macro: <input type="text" id="nome_macro" required /></label><br />
    <label>Categoria da Macro: <input type="text" id="categoria_macro" /></label><br />
    <label>Macro:<br /><textarea id="conteudo_macro" rows="5" required></textarea></label><br />
    <button type="submit">Salvar Macro</button>
    <button type="button" onclick="cancelarEdicao()">Cancelar</button>
  </form>

  <button onclick="exportarPDF()">Exportar PDF</button>
  <input type="file" onchange="importarMacros(event)" />

  <div id="lista_macros"></div>

  <script>
    const firebaseConfig = { /* suas configurações */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const ref = db.collection("macros");
    let macros = [];

    async function carregarMacros() {
      const snapshot = await ref.get();
      macros = snapshot.docs.map(doc => ({ id: doc.id, favorito: false, ...doc.data() }));
      exibirMacros();
    }

    function exibirMacros() {
      const busca = document.getElementById("busca").value.toLowerCase();
      const container = document.getElementById("lista_macros");
      container.innerHTML = "";
      macros.filter(m => m.nome.toLowerCase().includes(busca)).forEach((m, i) => {
        const div = document.createElement("div");
        div.className = "macro-item";
        div.innerHTML = `
          <strong class="${m.favorito ? 'favorite' : ''}">${m.nome}</strong> (${m.categoria || "Sem categoria"})<br />
          <pre>${m.conteudo}</pre>
          <div class="macro-buttons">
            <button onclick="editarMacro(${i}); window.scrollTo(0, 0)">Editar</button>
            <button onclick="excluirMacro('${m.id}')">Excluir</button>
            <button onclick="copiarMacro('${m.conteudo}')">Copiar</button>
            <button onclick="backupMacro(${i})">Backup</button>
            <button onclick="favoritarMacro(${i})">${m.favorito ? '★' : '☆'}</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    document.getElementById("formMacro").onsubmit = async (e) => {
      e.preventDefault();
      const nome = document.getElementById("nome_macro").value.trim();
      const categoria = document.getElementById("categoria_macro").value.trim();
      const conteudo = document.getElementById("conteudo_macro").value.trim();
      const index = document.getElementById("index_edicao").value;

      if (index) {
        await ref.doc(macros[index].id).set({ nome, categoria, conteudo });
      } else {
        await ref.add({ nome, categoria, conteudo });
      }

      document.getElementById("formMacro").reset();
      document.getElementById("index_edicao").value = "";
      carregarMacros();
    };

    function editarMacro(i) {
      const m = macros[i];
      document.getElementById("nome_macro").value = m.nome;
      document.getElementById("categoria_macro").value = m.categoria;
      document.getElementById("conteudo_macro").value = m.conteudo;
      document.getElementById("index_edicao").value = i;
    }

    async function excluirMacro(id) {
      if (confirm("Deseja excluir esta macro?")) {
        await ref.doc(id).delete();
        carregarMacros();
      }
    }

    function cancelarEdicao() {
      document.getElementById("formMacro").reset();
      document.getElementById("index_edicao").value = "";
    }

    function buscarMacros() { exibirMacros(); }

    function copiarMacro(conteudo) {
      navigator.clipboard.writeText(conteudo);
      alert("Macro copiada para a área de transferência!");
    }

    function favoritarMacro(i) {
      macros[i].favorito = !macros[i].favorito;
      exibirMacros();
    }

    function backupMacro(i) {
      const blob = new Blob([macros[i].conteudo], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${macros[i].nome}.txt`;
      a.click();
    }

    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      macros.forEach((m, idx) => {
        doc.text(`${m.nome} (${m.categoria})`, 10, 10 + idx * 20);
        doc.text(m.conteudo, 10, 20 + idx * 20);
      });
      doc.save("macros_exportadas.pdf");
    }

    function importarMacros(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = JSON.parse(e.target.result);
          for (const m of data) {
            if (m.nome && m.conteudo) {
              await ref.add({ nome: m.nome, categoria: m.categoria || "", conteudo: m.conteudo });
            }
          }
          carregarMacros();
        } catch (err) {
          alert("Erro ao importar: " + err.message);
        }
      };
      reader.readAsText(file);
    }

    carregarMacros();
  </script>
</body>
</html>
